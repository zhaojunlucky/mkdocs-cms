
<div class="repository-import-container">
  <mat-card class="import-header">
    <mat-card-content>
      <button mat-button color="primary" routerLink="/home">
        <mat-icon>arrow_back</mat-icon>
        Back to Repositories
      </button>
      <h1>Import GitHub Repositories</h1>
      <p class="description">Select repositories to import from your GitHub account.</p>
    </mat-card-content>
  </mat-card>

  @if (loading) {
    <div class="loading-indicator">
      <mat-spinner diameter="40"></mat-spinner>
      <p>Loading...</p>
    </div>
  }

  @if (error) {
    <mat-card class="error-message">
      <mat-card-content>
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
          <mat-icon color="warn">error</mat-icon>
          <p>{{ error }}</p>
        </div>
        @if (installations.length === 0 && githubAppInfo) {
          <button
            mat-raised-button
            color="primary"
            (click)="navigateToGitHubAppInstallation()">
            <mat-icon>launch</mat-icon>
            Install GitHub App
          </button>
        }
      </mat-card-content>
    </mat-card>
  }

  @if (importSuccess) {
    <mat-card class="success-message">
      <mat-card-content>
        <div style="display: flex; align-items: center; gap: 8px;">
          <mat-icon color="primary">check_circle</mat-icon>
          <p>Repositories imported successfully! Redirecting to home page...</p>
        </div>
      </mat-card-content>
    </mat-card>
  }

  @if (!loading && !importSuccess) {
    <div>
      <!-- Installation Selection -->
      @if (installations.length > 0) {
        <mat-card class="installation-section">
          <mat-card-header>
            <mat-card-title>Select GitHub Installation</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <mat-selection-list class="installation-list" [multiple]="false">
              @for (installation of installations; track installation) {
                <mat-list-option
                  [value]="installation.id"
                  [selected]="selectedInstallation === installation.id"
                  (click)="onInstallationChange(installation.id)">
                  <img matListItemAvatar [src]="installation.account.avatar_url" alt="GitHub Avatar">
                  <span matListItemTitle>{{ installation.account.login }}</span>
                </mat-list-option>
              }
            </mat-selection-list>
          </mat-card-content>
        </mat-card>
      }
      <!-- No Installations Message -->
      @if (installations.length === 0 && !loading) {
        <mat-card class="no-installations">
          <mat-card-content>
            <div style="text-align: center; padding: 40px;">
              <mat-icon style="font-size: 48px; height: 48px; width: 48px; color: #ccc;">github</mat-icon>
              <p>No GitHub installations found. Please install the GitHub App to your account first.</p>
              <button
                mat-raised-button
                color="primary"
                (click)="navigateToGitHubAppInstallation()">
                <mat-icon>launch</mat-icon>
                Install GitHub App
              </button>
            </div>
          </mat-card-content>
        </mat-card>
      }
      <!-- Repository Selection -->
      @if (repositories.length > 0) {
        <mat-card class="repository-section">
          <mat-card-header class="repository-header">
            <mat-card-title>Select Repositories to Import</mat-card-title>
            <div class="selection-controls">
              <button mat-button color="primary" (click)="selectAll(true)">Select All</button>
              <button mat-button (click)="selectAll(false)">Deselect All</button>
            </div>
          </mat-card-header>
          <mat-card-content>
            <mat-selection-list class="repository-list">
              @for (repo of repositories; track repo) {
                <mat-list-option
                  [value]="repo"
                  [selected]="repo.selected"
                  (click)="toggleSelectRepository(repo)">
                  <mat-icon matListItemIcon>{{ repo.private ? 'lock' : 'public' }}</mat-icon>
                  <div matListItemTitle>{{ repo.full_name }}</div>
                  <div matListItemLine>
                    @if (repo.description) {
                      {{ repo.description }}
                    }
                    @if (!repo.description) {
                      <em>No description</em>
                    }
                  </div>
                  <mat-chip class="repo-visibility" [class.private]="repo.private">
                    {{ repo.private ? 'Private' : 'Public' }}
                  </mat-chip>
                </mat-list-option>
              }
            </mat-selection-list>
          </mat-card-content>
          <mat-card-actions class="import-actions">
            <button mat-raised-button color="primary" (click)="importRepositories()" [disabled]="!hasSelectedRepositories()">
              <mat-icon>download</mat-icon>
              Import Selected Repositories
            </button>
          </mat-card-actions>
        </mat-card>
      }
      <!-- No Repositories Message -->
      @if (repositories.length === 0 && selectedInstallation && !loading) {
        <mat-card class="no-repositories">
          <mat-card-content>
            <div style="text-align: center; padding: 40px;">
              <mat-icon style="font-size: 48px; height: 48px; width: 48px; color: #ccc;">folder_open</mat-icon>
              <p>No repositories found for this installation or all repositories have already been imported.</p>
              <p>Go to <a href="https://github.com/settings/installations/{{selectedInstallation}}" target="_blank">GitHub Settings</a> to authorize more repositories for Mkdocs CMS App.</p>
            </div>
          </mat-card-content>
        </mat-card>
    }
  </div>
}
</div>
