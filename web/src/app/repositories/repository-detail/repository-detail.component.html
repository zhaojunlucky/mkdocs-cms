<div class="repository-detail-container">
  <!-- Loading overlay that blocks user interaction -->
  <div *ngIf="isLoading" class="loading-overlay">
    <div class="spinner-container">
      <mat-spinner diameter="50"></mat-spinner>
      <p>Loading...</p>
    </div>
  </div>

  <div *ngIf="error" class="error-message">
    <p>{{ error }}</p>
    <a routerLink="/home" class="back-btn">Back to Home</a>
  </div>

  <div *ngIf="!isLoading && !error && repository">
    <div class="repository-header">
      <a routerLink="/home" class="back-link"><h1>{{ repository.name }}</h1></a>
    </div>

    <div class="content-layout">
      <!-- Sidenav for collections -->
      <div class="sidenav">
        <div class="sidenav-header">
          <h3>Collections</h3>
        </div>
        <div class="sidenav-content">
          <div *ngIf="collections.length === 0" class="empty-state-sidenav">
            <p>No collections found</p>
          </div>
          <ul class="collection-list">
            <li *ngFor="let collection of collections"
                [class.active]="selectedCollection?.name === collection.name"
                (click)="selectCollection(collection)">
              <span class="collection-name">{{ collection.name }}</span>
            </li>
          </ul>
        </div>
      </div>

      <!-- Main content area -->
      <div class="main-content">
        <!-- Show info message if no collection is selected -->
        <div *ngIf="!selectedCollection && !isEditingFile" class="info-message-large">
          <p>Select a collection from the sidebar to browse its files.</p>
        </div>

        <!-- Show files and folders when a collection is selected and not editing a file -->
        <div *ngIf="selectedCollection && !isEditingFile" class="file-browser">
          <div class="file-browser-header">
            <h2>{{ selectedCollection.name }}</h2>
            <div class="breadcrumbs-container" style="display: flex; justify-content: space-between; align-items: center;">
              <div class="breadcrumbs">
                <span class="breadcrumb-item" (click)="navigateToBreadcrumb('')">Root</span>
                <span *ngFor="let segment of pathSegments">
                  <span class="breadcrumb-separator">/</span>
                  <span class="breadcrumb-item" (click)="navigateToBreadcrumb(segment.path)">{{ segment.name }}</span>
                </span>
              </div>
              <div style="display: flex; justify-content: flex-end; gap: 8px;">
                <button mat-raised-button color="primary" *ngIf="!isEditingFile" (click)="createNewFolder()">
                  <mat-icon>create_new_folder</mat-icon>
                  New Folder
                </button>
                <button mat-raised-button color="primary" *ngIf="!isEditingFile" (click)="createNewFile()">
                  <mat-icon>add</mat-icon>
                  New File
                </button>
              </div>
            </div>
          </div>

          <div *ngIf="isLoading" class="loading-indicator">
            <p>Loading files...</p>
          </div>

          <div *ngIf="!isLoading && (!files || files.length === 0)" class="empty-state">
            <p>This folder is empty.</p>
          </div>

          <div *ngIf="!isLoading && files && files.length > 0" class="file-list">
            <div *ngFor="let file of files" class="file-item"
                 [class.is-folder]="file.is_dir"
                 (click)="file.is_dir ? navigateToFolder(file) : openFile(file)">
              <div class="file-icon">
                <span *ngIf="file.is_dir" class="material-icons">folder</span>
                <span *ngIf="!file.is_dir" class="material-icons">insert_drive_file</span>
              </div>
              <div class="file-details">
                <div class="file-name" style="display: flex; justify-content: space-between; align-items: center;">
                  <span>{{ file.name }}</span>
                  <button *ngIf="!file.is_dir"
                          mat-icon-button
                          [matMenuTriggerFor]="fileMenu"
                          (click)="$event.stopPropagation()">
                    <mat-icon>more_vert</mat-icon>
                  </button>
                  <mat-menu #fileMenu="matMenu">
                    <button mat-menu-item (click)="renameFile(file)">
                      <mat-icon>edit</mat-icon>
                      <span>Rename</span>
                    </button>
                    <button mat-menu-item (click)="deleteFile(file)">
                      <mat-icon>delete</mat-icon>
                      <span>Delete</span>
                    </button>
                  </mat-menu>
                </div>
                <div class="file-meta">
                  <span *ngIf="!file.is_dir">{{ file.size | number }} bytes</span>
                  <span>{{ file.mod_time | date:'medium' }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- File Editor (Inline) -->
        <div *ngIf="isEditingFile" class="file-editor">
          <div class="file-editor-header">
            <div class="file-editor-title">
              <h2>{{ isCreatingFile ? 'Create New File' : 'Editing: ' + selectedFile?.name }}</h2>
              <div class="breadcrumbs-container" style="display: flex; justify-content: space-between; align-items: center;">
                <div class="breadcrumbs">
                  <span >Root</span>
                  <span *ngFor="let segment of pathSegments">
                    <span class="breadcrumb-separator">/</span>
                    <span >{{ segment.name }}</span>
                  </span>
                  <span *ngIf="selectedFile">
                    <span class="breadcrumb-separator">/</span>
                    <span class=" active">{{ selectedFile.name }}</span>
                  </span>
                </div>
                <div style="display: flex; justify-content: flex-end; gap: 8px;">
                  <button (click)="isCreatingFile ? saveNewFile() : saveFile()" [disabled]="savingFile" class="save-btn">
                    <span *ngIf="!savingFile">{{ isCreatingFile ? 'Create' : 'Save' }}</span>
                    <span *ngIf="savingFile">{{ isCreatingFile ? 'Creating...' : 'Saving...' }}</span>
                  </button>
                  <button (click)="cancelEditing()" [disabled]="savingFile" class="cancel-btn">Cancel</button>
                </div>
              </div>
            </div>
            <div class="file-editor-actions">
            </div>
          </div>

          <!-- File Error Message -->
          <div *ngIf="fileError" class="file-error-message">
            <p>{{ fileError }}</p>
          </div>

          <!-- Editor Content (only show when not loading) -->
          <div *ngIf="!isLoading && !fileError" class="file-editor-content">
            <!-- File Name Input (when creating) -->
            <div *ngIf="isCreatingFile" style="margin-bottom: 20px;">
              <h3>File Name</h3>
              <div style="display: flex; align-items: center; gap: 8px;">
                <input [(ngModel)]="newFileName" placeholder="Enter file name"
                  style="flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;"
                  [class.error]="fileError && !newFileName.trim()">
                <span style="font-size: 14px; color: #666;">.md</span>
              </div>
              <div *ngIf="fileError && !newFileName.trim()" style="color: #f44336; font-size: 12px; margin-top: 4px;">
                {{ fileError }}
              </div>
            </div>

            <!-- Front Matter Editor -->
            <app-front-matter-editor  *ngIf="selectedCollection?.fields"
              [frontMatter]="frontMatter"
              [fields]="selectedCollection?.fields??[]"
              (frontMatterChange)="onFrontMatterChange($event)">
            </app-front-matter-editor>

            <!-- Markdown Editor -->
            <div class="markdown-editor-wrapper">
              <h3>Content</h3>
              <nu-markdown  [(ngModel)]="markdownContent" [options]="editorOptions" (ready)="onEditorReady($event)"/>


            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
